{% extends 'base.html' %} 
{% block title %}Detalhes da Sala: {{ room.name }}{% endblock %} 
{% block content %}
<div class="min-h-screen p-8">
  <div class="max-w-4xl mx-auto">
    <div
      class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4"
    >
      <h1 class="text-4xl font-bold text-rpg-gold font-medieval">
        {{ room.name }}
      </h1>
      <div class="flex space-x-3">
        {% if room.master == user %}
        <a
          href="{% url 'room_templates:room-update-template' pk=room.pk %}"
          class="px-4 py-2 bg-yellow-600 text-gray-900 rounded-lg hover:bg-yellow-700 transition-colors"
        >
          <i class="fas fa-edit mr-2"></i>Editar
        </a>
        <a
          href="{% url 'room_templates:room-delete-template' pk=room.pk %}"
          class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
        >
          <i class="fas fa-trash-alt mr-2"></i>Excluir
        </a>
        {% endif %}
        <a
          href="{% url 'room_templates:room-list-template' %}"
          class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
        >
          <i class="fas fa-arrow-left mr-2"></i>Voltar para a Lista
        </a>
      </div>
    </div>

    <div
      class="bg-gray-800 p-8 rounded-xl shadow-2xl border-2 border-rpg-gold space-y-6"
    >
      <div class="pt-4 border-t border-gray-700">
        <h3 class="text-xl text-rpg-gold font-semibold mb-3">
          Gerenciamento de Personagens
        </h3>

        {# --- 1. Link de Criação de Personagem (Mestre ou Jogador) --- #}
        {% if room.master == user %}
        <a
            href="{% url 'room_templates:character-create-in-room' room_pk=room.pk %}"
            class="inline-block px-4 py-2 bg-rpg-green text-white rounded-lg hover:bg-green-700 transition-colors mb-4"
        >
            <i class="fas fa-plus-circle mr-2"></i> Criar NPC/Monstro (Mestre)
        </a>
        {% elif can_add_player_character %}
        <a
            href="{% url 'room_templates:character-create-in-room' room_pk=room.pk %}"
            class="inline-block px-4 py-2 bg-rpg-green text-white rounded-lg hover:bg-green-700 transition-colors mb-4"
        >
            <i class="fas fa-plus-circle mr-2"></i> Criar Meu Personagem (PJ)
        </a>
        {% else %}
            {% if user.user_type == 'player' %}
            <p class="text-sm text-gray-400 mb-4">
                Você já possui um Personagem Jogador ativo nesta sala.
            </p>
            {% endif %}
        {% endif %} 

        <div class="mt-4 pt-4 border-t border-gray-700">
            <h4 class="text-lg text-white font-semibold mb-3">
                Personagens Ativos na Sala
            </h4>
            <div class="flex flex-wrap gap-2">
                {% for character in current_characters %}
                <span class="bg-blue-800 text-white px-3 py-1 text-sm rounded-full">
                    {{ character.name }} 
                    ({{ character.get_character_type_display }}) 
                    {% if character.owner != room.master %}(Dono: {{ character.owner.username }}){% endif %}
                    {# TODO: Adicionar link para remover personagem (se for master) #}
                </span>
                {% empty %}
                <p class="text-gray-500">Nenhum personagem foi adicionado a esta sala.</p>
                {% endfor %}
            </div>
        </div>

      </div> 
      
      {# --- 2. Formulário de Adição de Personagem (Apenas Mestre) --- #}
      {% if room.master == user %}
      <div class="mt-4 pt-4 border-t border-rpg-gold">
        <h3 class="text-2xl text-rpg-gold font-medieval font-semibold mb-4">
          Adicionar Personagens à Sala
        </h3>

        <div class="bg-gray-900 p-6 rounded-xl space-y-4">
          <h4 class="text-xl text-white font-semibold mb-3">
            Personagens Disponíveis para Adição
          </h4>

          {% if available_characters %}
          <form
            method="POST"
            action="{% url 'room_templates:add-character-to-room' room_pk=room.pk %}"
            id="add-character-form"
            class="space-y-4"
          >
            {% csrf_token %}
            <label for="char_select" class="block text-gray-400">Selecione o Personagem:</label>
            <select name="character_pk" id="char_select" required
                    class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white">
                <option value="" disabled selected>--- Escolha um personagem ---</option>
                {% for character in available_characters %}
                    <option value="{{ character.pk }}">
                        {{ character.name }} ({{ character.get_character_type_display }}) 
                        {% if character.character_type == 'player' %}- Jogador: {{ character.owner.username }}{% endif %}
                        {% if character.character_type in 'npc' or character.character_type == 'monster' %}- MEU NPC{% endif %}
                    </option>
                {% endfor %}
            </select>
            
            <button type="submit" 
                    class="px-6 py-3 bg-rpg-green text-white font-semibold rounded-lg hover:bg-green-700 transition-colors w-full">
                Adicionar Selecionado
            </button>
          </form>
          {% else %}
            <p class="text-gray-500">Nenhum PJ livre ou NPC/Monstro de sua propriedade está disponível para adição.</p>
          {% endif %}
        </div>
      </div>
      {% endif %}
      
      {# --- 3. Gerenciamento de Jogadores (Sem Alteração) --- #}
      <div class="pt-4 border-t border-gray-700">
        <h3 class="text-xl text-rpg-gold font-semibold mb-3">
          Jogadores ({{ room.players.count }})
        </h3>

        {% if room.master == user %}
        <div class="flex flex-wrap gap-3">
          {% for player in room.players.all %}
          <div
            class="bg-rpg-green text-gray-900 font-semibold px-3 py-1 rounded-full flex items-center"
          >
            {{ player.username }} {% if player != user %}
            <a
              href="{% url 'room_templates:toggle-player-in-room' room_pk=room.pk user_pk=player.pk %}"
              class="ml-2 text-red-800 hover:text-red-600 transition-colors"
              title="Remover {{ player.username }}"
            >
              <i class="fas fa-times-circle text-lg"></i>
            </a>
            {% else %}
            <span class="ml-2 text-rpg-red">(Você)</span>
            {% endif %}
          </div>
          {% empty %}
          {% endfor %}
        </div>

        {% else %}
        {% endif %}
      </div>

      {% if room.master == user %}
      <div class="mt-4 pt-4 border-t border-rpg-gold">
        <div class="bg-gray-900 p-6 rounded-xl space-y-4">
          <h4 class="text-lg text-white font-semibold mb-3">
             Adicionar Jogadores
          </h4>
          <div
            class="flex flex-wrap gap-2 max-h-60 overflow-y-auto p-2 border border-gray-700 rounded-lg"
          >
            {% for possible_player in all_users %}
            <a
              href="{% url 'room_templates:toggle-player-in-room' room_pk=room.pk user_pk=possible_player.pk %}"
              class="bg-blue-600 text-white px-3 py-1 text-sm rounded-full hover:bg-blue-700 transition-colors flex items-center"
              title="Adicionar {{ possible_player.username }}"
            >
              <i class="fas fa-user-plus mr-1"></i> {{ possible_player.username
              }}
            </a>
            {% empty %}
              <p class="text-gray-500">Todos os jogadores disponíveis já estão na sala.</p>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}
      </div>
  </div>
</div>
{% endblock %}